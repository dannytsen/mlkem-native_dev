/*
 * Copyright (c) The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

/*yaml
  Name: poly_tobytes_asm
  Description: Convert polynomial to byte representation
  Signature: void mlk_poly_tobytes_asm(uint8_t r[384], const int16_t a[256])
  ABI:
    x0:
      type: buffer
      size_bytes: 384
      permissions: write-only
      c_parameter: uint8_t r[384]
      description: Output byte array
    x1:
      type: buffer
      size_bytes: 512
      permissions: read-only
      c_parameter: const int16_t a[256]
      description: Input polynomial
  Stack:
    bytes: 0
*/

#include "../../../common.h"
#if defined(MLK_ARITH_BACKEND_AARCH64) &&  !defined(MLK_CONFIG_MULTILEVEL_NO_SHARED)
/* simpasm: header-end */

.macro ld2_wrap a, ptr
        ldr q_tmp0, [\ptr\()], #32
        ldr q_tmp1, [\ptr\(), #-16]
        uzp1 \a\()0.8h, tmp0.8h, tmp1.8h
        uzp2 \a\()1.8h, tmp0.8h, tmp1.8h
.endm

        data0  .req v0
        data1  .req v1
        out0   .req v2
        out1   .req v3
        out2   .req v4
        tmp0   .req v5
        tmp1   .req v6
        q_tmp0 .req q5
        q_tmp1 .req q6

        dst   .req x0
        src   .req x1
        count .req x2

        .text
        .global MLK_ASM_NAMESPACE(poly_tobytes_asm)
        .balign 4
MLK_ASM_FN_SYMBOL(poly_tobytes_asm)

        mov count, #16
                                         // Instructions:    22
                                         // Expected cycles: 12
                                         // Expected IPC:    1.83
                                         //
                                         // Cycle bound:     12.0
                                         // IPC bound:       1.83
                                         //
                                         // Wall time:     0.11s
                                         // User time:     0.11s
                                         //
                                         // ----- cycle (expected) ------>
                                         // 0                        25
                                         // |------------------------|----
        ldr q5, [x1, #16]                // *.............................
        ldr q3, [x1], #32                // *.............................
        ldr q29, [x1], #32               // .*............................
        ldr q2, [x1, #-16]               // .*............................
        ldr q27, [x1, #16]               // ..*...........................
        ldr q23, [x1, #48]               // ..*...........................
        ldr q17, [x1], #32               // ...*..........................
        ldr q16, [x1], #32               // ...*..........................
        uzp2 v26.8H, v3.8H, v5.8H        // ....*.........................
        uzp1 v19.8H, v3.8H, v5.8H        // ....*.........................
        uzp2 v0.8H, v29.8H, v2.8H        // .....*........................
        uzp1 v1.8H, v29.8H, v2.8H        // .....*........................
        xtn v5.8B, v26.8H                // ......*.......................
        shrn v3.8B, v19.8H, #8           // ......*.......................
        shrn v4.8B, v26.8H, #4           // .......*......................
        xtn v18.8B, v0.8H                // .......*......................
        shrn v30.8B, v0.8H, #4           // ........*.....................
        xtn v28.8B, v1.8H                // ........*.....................
        shrn v29.8B, v1.8H, #8           // .........*....................
        sli v3.8B, v5.8B, #4             // ..........*...................
        xtn v2.8B, v19.8H                // ...........*..................
        sli v29.8B, v18.8B, #4           // ...........*..................

                                            // ------ cycle (expected) ------>
                                            // 0                        25
                                            // |------------------------|-----
        // ldr q17, [x1], #32               // *..............................
        // ldr q23, [x1, #16]               // .*.............................
        // ldr q27, [x1, #-16]              // *..............................
        // ldr q16, [x1], #32               // .*.............................
        // uzp1 v25.8H, v17.8H, v27.8H      // ....*..........................
        // uzp2 v31.8H, v17.8H, v27.8H      // ....*..........................
        // uzp1 v24.8H, v16.8H, v23.8H      // .....*.........................
        // uzp2 v6.8H, v16.8H, v23.8H       // .....*.........................
        // shrn v3.8B, v25.8H, #8           // ......*........................
        // ldr q17, [x1], #32               // ...*...........................
        // shrn v4.8B, v31.8H, #4           // .......*.......................
        // xtn v21.8B, v6.8H                // .......*.......................
        // ldr q23, [x1, #16]               // ..*............................
        // shrn v29.8B, v24.8H, #8          // .........*.....................
        // ldr q27, [x1, #-16]              // ..*............................
        // xtn v20.8B, v31.8H               // ......*........................
        // ldr q16, [x1], #32               // ...*...........................
        // sli v29.8B, v21.8B, #4           // ...........*...................
        // xtn v2.8B, v25.8H                // ...........*...................
        // sli v3.8B, v20.8B, #4            // ..........*....................
        // xtn v28.8B, v24.8H               // ........*......................
        // shrn v30.8B, v6.8H, #4           // ........*......................

        lsr count, count, #1
        sub count, count, #2
poly_tobytes_loop_start:
                                                       // Instructions:    20
                                                       // Expected cycles: 10
                                                       // Expected IPC:    2.00
                                                       //
                                                       // Cycle bound:     11.0
                                                       // IPC bound:       1.82
                                                       //
                                                       // Wall time:     3.09s
                                                       // User time:     3.09s
                                                       //
                                                       // ----- cycle (expected) ------>
                                                       // 0                        25
                                                       // |------------------------|----
        uzp1 v25.8H, v17.8H, v27.8H                    // *.............................
        uzp2 v31.8H, v17.8H, v27.8H                    // *.............................
        uzp1 v24.8H, v16.8H, v23.8H                    // .*............................
        uzp2 v6.8H, v16.8H, v23.8H                     // .*............................
        st3 {v2.8B, v3.8B, v4.8B}, [x0], #24           // ..l...........................
        shrn v3.8B, v25.8H, #8                         // ..*...........................
        ldr q17, [x1], #32                             // ...e..........................
        shrn v4.8B, v31.8H, #4                         // ...*..........................
        xtn v21.8B, v6.8H                              // ....*.........................
        ldr q23, [x1, #16]                             // ....e.........................
        st3 {v28.8B, v29.8B, v30.8B}, [x0], #24        // .....l........................
        shrn v29.8B, v24.8H, #8                        // .....*........................
        ldr q27, [x1, #-16]                            // ......e.......................
        xtn v20.8B, v31.8H                             // ......*.......................
        ldr q16, [x1], #32                             // .......e......................
        sli v29.8B, v21.8B, #4                         // .......*......................
        xtn v2.8B, v25.8H                              // ........*.....................
        sli v3.8B, v20.8B, #4                          // ........*.....................
        xtn v28.8B, v24.8H                             // .........*....................
        shrn v30.8B, v6.8H, #4                         // .........*....................

                                                     // ------ cycle (expected) ------>
                                                     // 0                        25
                                                     // |------------------------|-----
        // ldr q5, [x1], #32                         // e......'..~......'..~......'...
        // ldr q6, [x1, #-16]                        // ...e...'.....~...'.....~...'...
        // uzp1 v0.8h, v5.8h, v6.8h                  // .......*.........~.........~...
        // uzp2 v1.8h, v5.8h, v6.8h                  // .......*.........~.........~...
        // xtn v2.8b, v0.8h                          // .....~.'.......*.'.......~.'...
        // shrn v3.8b, v0.8h, #8                     // .......'.*.......'.~.......'.~.
        // xtn v5.8b, v1.8h                          // ...~...'.....*...'.....~...'...
        // sli v3.8b, v5.8b, #4                      // .....~.'.......*.'.......~.'...
        // shrn v4.8b, v1.8h, #4                     // ~......'..*......'..~......'...
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // .......'.~.......'.l.......'.~.
        // ldr q5, [x1], #32                         // ....e..'......~..'......~..'...
        // ldr q6, [x1, #-16]                        // .e.....'...~.....'...~.....'...
        // uzp1 v0.8h, v5.8h, v6.8h                  // .......'*........'~........'~..
        // uzp2 v1.8h, v5.8h, v6.8h                  // .......'*........'~........'~..
        // xtn v2.8b, v0.8h                          // ......~'........*'........~'...
        // shrn v3.8b, v0.8h, #8                     // ..~....'....*....'....~....'...
        // xtn v5.8b, v1.8h                          // .~.....'...*.....'...~.....'...
        // sli v3.8b, v5.8b, #4                      // ....~..'......*..'......~..'...
        // shrn v4.8b, v1.8h, #4                     // ......~'........*'........~'...
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // ..~....'....~....'....l....'...

        subs count, count, 1
        cbnz count, poly_tobytes_loop_start
                                                       // Instructions:    18
                                                       // Expected cycles: 12
                                                       // Expected IPC:    1.50
                                                       //
                                                       // Cycle bound:     12.0
                                                       // IPC bound:       1.50
                                                       //
                                                       // Wall time:     0.11s
                                                       // User time:     0.11s
                                                       //
                                                       // ----- cycle (expected) ------>
                                                       // 0                        25
                                                       // |------------------------|----
        uzp2 v7.8H, v17.8H, v27.8H                     // *.............................
        uzp1 v25.8H, v17.8H, v27.8H                    // *.............................
        uzp2 v0.8H, v16.8H, v23.8H                     // .*............................
        st3 {v2.8B, v3.8B, v4.8B}, [x0], #24           // .*............................
        st3 {v28.8B, v29.8B, v30.8B}, [x0], #24        // ..*...........................
        shrn v21.8B, v25.8H, #8                        // ....*.........................
        uzp1 v2.8H, v16.8H, v23.8H                     // .....*........................
        shrn v22.8B, v7.8H, #4                         // .....*........................
        shrn v4.8B, v0.8H, #4                          // ......*.......................
        xtn v28.8B, v7.8H                              // ......*.......................
        xtn v27.8B, v0.8H                              // .......*......................
        shrn v3.8B, v2.8H, #8                          // .......*......................
        sli v21.8B, v28.8B, #4                         // ........*.....................
        xtn v2.8B, v2.8H                               // ........*.....................
        sli v3.8B, v27.8B, #4                          // .........*....................
        xtn v20.8B, v25.8H                             // .........*....................
        st3 {v20.8B, v21.8B, v22.8B}, [x0], #24        // ...........*..................
        st3 {v2.8B, v3.8B, v4.8B}, [x0], #24           // ...........*..................

                                                        // ------ cycle (expected) ------>
                                                        // 0                        25
                                                        // |------------------------|-----
        // uzp1 v25.8H, v17.8H, v27.8H                  // *..............................
        // uzp2 v31.8H, v17.8H, v27.8H                  // *..............................
        // uzp1 v24.8H, v16.8H, v23.8H                  // .....*.........................
        // uzp2 v6.8H, v16.8H, v23.8H                   // .*.............................
        // st3 {v2.8B, v3.8B, v4.8B}, [x0], #24         // .*.............................
        // shrn v3.8B, v25.8H, #8                       // ....*..........................
        // shrn v4.8B, v31.8H, #4                       // .....*.........................
        // xtn v21.8B, v6.8H                            // .......*.......................
        // st3 {v28.8B, v29.8B, v30.8B}, [x0], #24      // ..*............................
        // shrn v29.8B, v24.8H, #8                      // .......*.......................
        // xtn v20.8B, v31.8H                           // ......*........................
        // sli v29.8B, v21.8B, #4                       // .........*.....................
        // xtn v2.8B, v25.8H                            // .........*.....................
        // sli v3.8B, v20.8B, #4                        // ........*......................
        // xtn v28.8B, v24.8H                           // ........*......................
        // shrn v30.8B, v6.8H, #4                       // ......*........................
        // st3 {v2.8B, v3.8B, v4.8B}, [x0], #24         // ...........*...................
        // st3 {v28.8B, v29.8B, v30.8B}, [x0], #24      // ...........*...................

        ret

        .unreq data0
        .unreq data1
        .unreq out0
        .unreq out1
        .unreq out2
        .unreq tmp0
        .unreq tmp1
        .unreq q_tmp0
        .unreq q_tmp1
        .unreq dst
        .unreq src
        .unreq count

/* simpasm: footer-start */
#endif /* MLK_ARITH_BACKEND_AARCH64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED */
