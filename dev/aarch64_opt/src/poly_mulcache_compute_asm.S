/*
 * Copyright (c) The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

/*yaml
  Name: poly_mulcache_compute_asm
  Description: Compute multiplication cache for polynomial
  Signature: void mlk_poly_mulcache_compute_asm(int16_t cache[128], const int16_t mlk_poly[256], const int16_t zetas[128], const int16_t zetas_twisted[128])
  ABI:
    x0:
      type: buffer
      size_bytes: 256
      permissions: write-only
      c_parameter: int16_t cache[128]
      description: Output cache
    x1:
      type: buffer
      size_bytes: 512
      permissions: read-only
      c_parameter: const int16_t mlk_poly[256]
      description: Input polynomial
    x2:
      type: buffer
      size_bytes: 256
      permissions: read-only
      c_parameter: const int16_t zetas[128]
      description: Zeta values
    x3:
      type: buffer
      size_bytes: 256
      permissions: read-only
      c_parameter: const int16_t zetas_twisted[128]
      description: Twisted zeta values
  Stack:
    bytes: 0
*/

#include "../../../common.h"
#if defined(MLK_ARITH_BACKEND_AARCH64) &&  !defined(MLK_CONFIG_MULTILEVEL_NO_SHARED)
/* simpasm: header-end */

/* Montgomery multiplication, with precomputed Montgomery twist
 * Expects modulus in consts.h[0]. */
.macro mulmod dst, src, const, const_twisted
        sqrdmulh tmp0.8h,    \src\().8h, \const_twisted\().8h
        mul      \dst\().8h, \src\().8h, \const\().8h
        mls      \dst\().8h, tmp0.8h,    modulus.h[0]
.endm

        cache_ptr         .req x0
        data_ptr          .req x1
        zeta_ptr          .req x2
        zeta_twisted_ptr  .req x3
        count             .req x4
        wtmp              .req w5

        data_odd          .req v0
        zeta              .req v1
        q_zeta            .req q1
        zeta_twisted      .req v2
        q_zeta_twisted    .req q2

        tmp0              .req v3
        q_tmp0            .req q3
        tmp1              .req v4
        q_tmp1            .req q4
        dst               .req v5
        q_dst             .req q5

        modulus           .req v6
        modulus_twisted   .req v7

        .global MLK_ASM_NAMESPACE(poly_mulcache_compute_asm)
        .text
        .balign 4
MLK_ASM_FN_SYMBOL(poly_mulcache_compute_asm)
        mov wtmp, #3329
        dup modulus.8h, wtmp

        mov wtmp, #20159
        dup modulus_twisted.8h, wtmp

        mov count, #16
                                              // Instructions:    21
                                              // Expected cycles: 15
                                              // Expected IPC:    1.40
                                              //
                                              // Cycle bound:     15.0
                                              // IPC bound:       1.40
                                              //
                                              // Wall time:     0.11s
                                              // User time:     0.11s
                                              //
                                              // ----- cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|----
        ldr q0, [x1], #32                     // *.............................
        ldr q2, [x1, #-16]                    // *.............................
        ldr q19, [x1], #32                    // .*............................
        ldr q29, [x3], #16                    // .*............................
        ldr q16, [x1, #-16]                   // ..*...........................
        ldr q18, [x2], #16                    // ..*...........................
        ldr q26, [x1], #32                    // ...*..........................
        ldr q25, [x2], #16                    // ...*..........................
        uzp2 v5.8H, v0.8H, v2.8H              // ....*.........................
        ldr q28, [x3], #16                    // ....*.........................
        ldr q7, [x1, #-16]                    // .....*........................
        ldr q2, [x1], #32                     // .....*........................
        uzp2 v27.8H, v19.8H, v16.8H           // ......*.......................
        sqrdmulh v16.8H, v5.8H, v29.8H        // ......*.......................
        ldr q17, [x3], #16                    // .......*......................
        ldr q19, [x3], #16                    // .......*......................
        mul v5.8H, v5.8H, v18.8H              // ........*.....................
        uzp2 v29.8H, v26.8H, v7.8H            // .........*....................
        mul v26.8H, v27.8H, v25.8H            // ..........*...................
        sqrdmulh v4.8H, v27.8H, v28.8H        // ............*.................
        mls v5.8H, v16.8H, v6.H[0]            // ..............*...............

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ldr q0, [x1], #32                    // *..............................
        // ldr q16, [x1, #-16]                  // *..............................
        // ldr q17, [x3], #16                   // .*.............................
        // uzp2 v29.8H, v0.8H, v16.8H           // ....*..........................
        // ldr q2, [x1], #32                    // .*.............................
        // ldr q19, [x3], #16                   // ....*..........................
        // sqrdmulh v22.8H, v29.8H, v17.8H      // ......*........................
        // ldr q28, [x2], #16                   // ..*............................
        // ldr q24, [x1, #-16]                  // ..*............................
        // ldr q0, [x1], #32                    // ...*...........................
        // ldr q16, [x1, #-16]                  // .....*.........................
        // ldr q17, [x3], #16                   // .......*.......................
        // mul v5.8H, v29.8H, v28.8H            // ........*......................
        // uzp2 v23.8H, v2.8H, v24.8H           // ......*........................
        // ldr q18, [x2], #16                   // ...*...........................
        // mls v5.8H, v22.8H, v6.H[0]           // ..............*................
        // uzp2 v29.8H, v0.8H, v16.8H           // .........*.....................
        // sqrdmulh v4.8H, v23.8H, v19.8H       // ............*..................
        // ldr q2, [x1], #32                    // .....*.........................
        // ldr q19, [x3], #16                   // .......*.......................
        // mul v26.8H, v23.8H, v18.8H           // ..........*....................

        lsr count, count, #1
        sub count, count, #2
poly_mulcache_compute_loop_start:
                                               // Instructions:    18
                                               // Expected cycles: 12
                                               // Expected IPC:    1.50
                                               //
                                               // Cycle bound:     12.0
                                               // IPC bound:       1.50
                                               //
                                               // Wall time:     0.12s
                                               // User time:     0.12s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        str q5, [x0], #16                      // l.............................
        sqrdmulh v22.8H, v29.8H, v17.8H        // .*............................
        ldr q28, [x2], #16                     // .*............................
        ldr q24, [x1, #-16]                    // ..*...........................
        ldr q0, [x1], #32                      // ...e..........................
        mls v26.8H, v4.8H, v6.H[0]             // ...l..........................
        ldr q16, [x1, #-16]                    // ....e.........................
        ldr q17, [x3], #16                     // .....e........................
        mul v5.8H, v29.8H, v28.8H              // .....*........................
        uzp2 v23.8H, v2.8H, v24.8H             // ......*.......................
        ldr q18, [x2], #16                     // ......*.......................
        mls v5.8H, v22.8H, v6.H[0]             // .......*......................
        uzp2 v29.8H, v0.8H, v16.8H             // ........e.....................
        sqrdmulh v4.8H, v23.8H, v19.8H         // .........*....................
        ldr q2, [x1], #32                      // .........e....................
        ldr q19, [x3], #16                     // ..........e...................
        str q26, [x0], #16                     // ...........l..................
        mul v26.8H, v23.8H, v18.8H             // ...........*..................

                                                  // ------- cycle (expected) ------->
                                                  // 0                        25
                                                  // |------------------------|-------
        // ldr q3, [x1], #32                      // e........'..~........'..~........
        // ldr q4, [x1, #-16]                     // .e.......'...~.......'...~.......
        // ldr q1, [x2], #16                      // .........'*..........'~..........
        // ldr q2, [x3], #16                      // ..e......'....~......'....~......
        // uzp2 v0.8h, v3.8h, v4.8h               // .....e...'.......~...'.......~...
        // sqrdmulh v3.8h,    v0.8h, v2.8h        // .........'*..........'~..........
        // mul      v5.8h, v0.8h, v1.8h           // ..~......'....*......'....~......
        // mls      v5.8h, v3.8h,    v6.h[0]      // ....~....'......*....'......~....
        // str q5, [x0], #16                      // .........~...........l...........
        // ldr q3, [x1], #32                      // ......e..'........~..'........~..
        // ldr q4, [x1, #-16]                     // .........'.*.........'.~.........
        // ldr q1, [x2], #16                      // ...~.....'.....*.....'.....~.....
        // ldr q2, [x3], #16                      // .......e.'.........~.'.........~.
        // uzp2 v0.8h, v3.8h, v4.8h               // ...~.....'.....*.....'.....~.....
        // sqrdmulh v3.8h,    v0.8h, v2.8h        // ......~..'........*..'........~..
        // mul      v5.8h, v0.8h, v1.8h           // ........~'..........*'...........
        // mls      v5.8h, v3.8h,    v6.h[0]      // ~........'..~........'..l........
        // str q5, [x0], #16                      // ........~'..........~'..........l

        subs count, count, 1
        cbnz count, poly_mulcache_compute_loop_start
                                               // Instructions:    15
                                               // Expected cycles: 19
                                               // Expected IPC:    0.79
                                               //
                                               // Cycle bound:     19.0
                                               // IPC bound:       0.79
                                               //
                                               // Wall time:     0.05s
                                               // User time:     0.05s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        mls v26.8H, v4.8H, v6.H[0]             // *.............................
        str q5, [x0], #16                      // *.............................
        ldr q5, [x2], #16                      // .*............................
        ldr q4, [x1, #-16]                     // .*............................
        sqrdmulh v16.8H, v29.8H, v17.8H        // ..*...........................
        ldr q0, [x2], #16                      // ..*...........................
        mul v29.8H, v29.8H, v5.8H              // .....*........................
        uzp2 v18.8H, v2.8H, v4.8H              // .....*........................
        str q26, [x0], #16                     // ......*.......................
        sqrdmulh v17.8H, v18.8H, v19.8H        // .......*......................
        mls v29.8H, v16.8H, v6.H[0]            // .........*....................
        mul v26.8H, v18.8H, v0.8H              // ...........*..................
        mls v26.8H, v17.8H, v6.H[0]            // .............*................
        str q29, [x0], #16                     // ..............*...............
        str q26, [x0], #16                     // ..................*...........

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // str q5, [x0], #16                    // *..............................
        // sqrdmulh v22.8H, v29.8H, v17.8H      // ..*............................
        // ldr q28, [x2], #16                   // .*.............................
        // ldr q24, [x1, #-16]                  // .*.............................
        // mls v26.8H, v4.8H, v6.H[0]           // *..............................
        // mul v5.8H, v29.8H, v28.8H            // .....*.........................
        // uzp2 v23.8H, v2.8H, v24.8H           // .....*.........................
        // ldr q18, [x2], #16                   // ..*............................
        // mls v5.8H, v22.8H, v6.H[0]           // .........*.....................
        // sqrdmulh v4.8H, v23.8H, v19.8H       // .......*.......................
        // str q26, [x0], #16                   // ......*........................
        // mul v26.8H, v23.8H, v18.8H           // ...........*...................
        // str q5, [x0], #16                    // ..............*................
        // mls v26.8H, v4.8H, v6.H[0]           // .............*.................
        // str q26, [x0], #16                   // ..................*............


        ret

        .unreq cache_ptr
        .unreq data_ptr
        .unreq zeta_ptr
        .unreq zeta_twisted_ptr
        .unreq count
        .unreq wtmp

        .unreq data_odd
        .unreq zeta
        .unreq q_zeta
        .unreq zeta_twisted
        .unreq q_zeta_twisted

        .unreq tmp0
        .unreq q_tmp0
        .unreq tmp1
        .unreq q_tmp1
        .unreq dst
        .unreq q_dst

        .unreq modulus
        .unreq modulus_twisted

/* simpasm: footer-start */
#endif /* MLK_ARITH_BACKEND_AARCH64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED */
