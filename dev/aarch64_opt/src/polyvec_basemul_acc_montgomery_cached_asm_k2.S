/*
 * Copyright (c) The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

/* References
 * ==========
 *
 * - [NeonNTT]
 *   Neon NTT: Faster Dilithium, Kyber, and Saber on Cortex-A72 and Apple M1
 *   Becker, Hwang, Kannwischer, Yang, Yang
 *   https://eprint.iacr.org/2021/986
 */

/*yaml
  Name: polyvec_basemul_acc_montgomery_cached_asm_k2
  Description: Re-implementation of asymmetric base multiplication following @[NeonNTT] for k=2
  Signature: void mlk_polyvec_basemul_acc_montgomery_cached_asm_k2(int16_t r[256], const int16_t a[512], const int16_t b[512], const int16_t b_cache[256])
  ABI:
    x0:
      type: buffer
      size_bytes: 512
      permissions: write-only
      c_parameter: int16_t r[256]
      description: Output polynomial
    x1:
      type: buffer
      size_bytes: 1024
      permissions: read-only
      c_parameter: const int16_t a[512]
      description: Input polynomial vector a
    x2:
      type: buffer
      size_bytes: 1024
      permissions: read-only
      c_parameter: const int16_t b[512]
      description: Input polynomial vector b
    x3:
      type: buffer
      size_bytes: 512
      permissions: read-only
      c_parameter: const int16_t b_cache[256]
      description: Cached values for b
  Stack:
    bytes: 64
    description: saving callee-saved Neon registers
*/

/* Re-implementation of asymmetric base multiplication following @[NeonNTT] */

#include "../../../common.h"
#if defined(MLK_ARITH_BACKEND_AARCH64) &&  !defined(MLK_CONFIG_MULTILEVEL_NO_SHARED) &&  (defined(MLK_CONFIG_MULTILEVEL_WITH_SHARED) || MLKEM_K == 2)
/* simpasm: header-end */

// Input:
// - Vectors al, ah of 32-bit entries
// Output:
// - Montgomery reductions of al || ah, stored in al
.macro montgomery_reduce_long x, a
        uzp1   t0.8h, \a\()l.8h, \a\()h.8h
        mul    t0.8h, t0.8h, modulus_twisted.8h
        smlal  \a\()l.4s, t0.4h, modulus.4h
        smlal2 \a\()h.4s, t0.8h, modulus.8h
        uzp2   \x\().8h, \a\()l.8h, \a\()h.8h
.endm

// Computes products (a0*b0 + a0*b0t, a0*b1 + a1*b0) in 32-bit.

// Bounds:
// - Assume |a| < 4096,
// - Result: < 2*4096*2^15 = 2^28
.macro pmull d, a, b
        smull  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smull2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smull  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smull2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro pmlal d, a, b
        smlal  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smlal2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smlal  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smlal2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro ld2_wrap a, ptr
        ldr q_tmp0, [\ptr\()], #32
        ldr q_tmp1, [\ptr\(), #-16]
        uzp1 \a\()0.8h, tmp0.8h, tmp1.8h
        uzp2 \a\()1.8h, tmp0.8h, tmp1.8h
.endm

.macro st2_wrap a, ptr
        zip1 tmp0.8h, \a\()0.8h, \a\()1.8h
        zip2 tmp1.8h, \a\()0.8h, \a\()1.8h
        str q_tmp0, [\ptr\()], #32
        str q_tmp1, [\ptr\(), #-16]
.endm

.macro load_polys a, b, a_ptr, b_ptr, b_cache_ptr
        ld2_wrap \a\(), \a_ptr
        ld2_wrap \b\(), \b_ptr
        ld1 {\b\()1t.8h}, [\b_cache_ptr], #16
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

        out          .req x0
        a0_ptr       .req x1
        b0_ptr       .req x2
        b0_cache_ptr .req x3
        a1_ptr       .req x4
        b1_ptr       .req x5
        b1_cache_ptr .req x6
        a2_ptr       .req x7
        b2_ptr       .req x8
        b2_cache_ptr .req x9
        a3_ptr       .req x10
        b3_ptr       .req x11
        b3_cache_ptr .req x12
        count        .req x13
        wtmp         .req w14

        modulus           .req v0
        modulus_twisted   .req v2

        aa0      .req v3
        aa1      .req v4
        bb0      .req v5
        bb1      .req v6
        bb1t     .req v7

        res0l   .req v8
        res1l   .req v9
        res0h   .req v10
        res1h   .req v11

        tmp0 .req v12
        tmp1 .req v13
        q_tmp0 .req q12
        q_tmp1 .req q13

        out0 .req v26
        out1 .req v27

        t0   .req v28

        .text
        .global MLK_ASM_NAMESPACE(polyvec_basemul_acc_montgomery_cached_asm_k2)
        .balign 4
MLK_ASM_FN_SYMBOL(polyvec_basemul_acc_montgomery_cached_asm_k2)
        push_stack

        mov wtmp, #3329
        dup modulus.8h, wtmp

        mov wtmp, #3327
        dup modulus_twisted.8h, wtmp

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)

        mov count, #(MLKEM_N / 16)
                                             // Instructions:    70
                                             // Expected cycles: 39
                                             // Expected IPC:    1.79
                                             //
                                             // Cycle bound:     39.0
                                             // IPC bound:       1.79
                                             //
                                             // Wall time:     0.87s
                                             // User time:     0.87s
                                             //
                                             // ---------- cycle (expected) ---------->
                                             // 0                        25
                                             // |------------------------|-------------
        ldr q12, [x1], #32                   // *......................................
        ldr q9, [x1, #-16]                   // *......................................
        ldr q22, [x2], #32                   // .*.....................................
        ldr q30, [x2, #-16]                  // .*.....................................
        ldr q6, [x5], #32                    // ..*....................................
        ldr q7, [x4, #16]                    // ..*....................................
        ldr q8, [x4], #32                    // ...*...................................
        ldr q23, [x5, #-16]                  // ...*...................................
        uzp1 v16.8H, v12.8H, v9.8H           // ....*..................................
        uzp2 v14.8H, v12.8H, v9.8H           // ....*..................................
        uzp2 v13.8H, v22.8H, v30.8H          // .....*.................................
        uzp1 v18.8H, v22.8H, v30.8H          // .....*.................................
        ld1 {v27.8H}, [x3], #16              // ......*................................
        ld1 {v17.8H}, [x6], #16              // ......*................................
        smull2 v4.4S, v16.8H, v18.8H         // .......*...............................
        ldr q31, [x1, #16]                   // .......*...............................
        smull v19.4S, v16.4H, v13.4H         // ........*..............................
        ldr q24, [x1], #32                   // ........*..............................
        smlal v19.4S, v14.4H, v18.4H         // .........*.............................
        ldr q22, [x2], #32                   // .........*.............................
        smlal2 v4.4S, v14.8H, v27.8H         // ..........*............................
        uzp2 v5.8H, v6.8H, v23.8H            // ..........*............................
        smull2 v29.4S, v16.8H, v13.8H        // ...........*...........................
        uzp2 v26.8H, v8.8H, v7.8H            // ...........*...........................
        smlal2 v29.4S, v14.8H, v18.8H        // ............*..........................
        uzp1 v30.8H, v24.8H, v31.8H          // ............*..........................
        uzp1 v8.8H, v8.8H, v7.8H             // .............*.........................
        smull v11.4S, v16.4H, v18.4H         // .............*.........................
        smlal v11.4S, v14.4H, v27.4H         // ..............*........................
        ldr q1, [x2, #-16]                   // ..............*........................
        uzp1 v28.8H, v6.8H, v23.8H           // ...............*.......................
        smlal2 v29.4S, v8.8H, v5.8H          // ...............*.......................
        ldr q25, [x5], #32                   // ................*......................
        smlal v19.4S, v8.4H, v5.4H           // ................*......................
        ldr q3, [x4, #16]                    // .................*.....................
        smlal2 v29.4S, v26.8H, v28.8H        // .................*.....................
        uzp1 v27.8H, v22.8H, v1.8H           // ..................*....................
        smlal v19.4S, v26.4H, v28.4H         // ..................*....................
        ldr q12, [x4], #32                   // ...................*...................
        smlal2 v4.4S, v8.8H, v28.8H          // ...................*...................
        ldr q21, [x5, #-16]                  // ....................*..................
        smlal2 v4.4S, v26.8H, v17.8H         // ....................*..................
        smlal v11.4S, v8.4H, v28.4H          // .....................*.................
        ld1 {v15.8H}, [x6], #16              // .....................*.................
        smlal v11.4S, v26.4H, v17.4H         // ......................*................
        ld1 {v20.8H}, [x3], #16              // ......................*................
        uzp1 v28.8H, v19.8H, v29.8H          // .......................*...............
        smull2 v23.4S, v30.8H, v27.8H        // .......................*...............
        smull v26.4S, v30.4H, v27.4H         // ........................*..............
        uzp2 v16.8H, v22.8H, v1.8H           // .........................*.............
        mul v28.8H, v28.8H, v2.8H            // .........................*.............
        uzp1 v10.8H, v11.8H, v4.8H           // ..........................*............
        smull2 v8.4S, v30.8H, v16.8H         // ...........................*...........
        mul v13.8H, v10.8H, v2.8H            // ............................*..........
        smlal v19.4S, v28.4H, v0.4H          // ..............................*........
        smlal2 v29.4S, v28.8H, v0.8H         // ...............................*.......
        smull v18.4S, v30.4H, v16.4H         // ................................*......
        uzp1 v30.8H, v25.8H, v21.8H          // ................................*......
        smlal v11.4S, v13.4H, v0.4H          // .................................*.....
        uzp2 v6.8H, v24.8H, v31.8H           // .................................*.....
        uzp1 v16.8H, v12.8H, v3.8H           // ..................................*....
        smlal2 v4.4S, v13.8H, v0.8H          // ..................................*....
        uzp2 v17.8H, v25.8H, v21.8H          // ...................................*...
        smlal2 v8.4S, v6.8H, v27.8H          // ...................................*...
        uzp2 v12.8H, v12.8H, v3.8H           // ....................................*..
        smlal v18.4S, v6.4H, v27.4H          // ....................................*..
        uzp2 v9.8H, v19.8H, v29.8H           // .....................................*.
        smlal2 v8.4S, v16.8H, v17.8H         // .....................................*.
        smlal2 v8.4S, v12.8H, v30.8H         // ......................................*
        uzp2 v19.8H, v11.8H, v4.8H           // ......................................*

                                              // ---------- cycle (expected) ---------->
                                              // 0                        25
                                              // |------------------------|-------------
        // ldr q7, [x4], #32                  // ...*...................................
        // ldr q10, [x2, #16]                 // .*.....................................
        // ldr q14, [x2], #32                 // .*.....................................
        // uzp2 v21.8H, v14.8H, v10.8H        // .....*.................................
        // uzp1 v24.8H, v14.8H, v10.8H        // .....*.................................
        // ld1 {v15.8H}, [x6], #16            // ......*................................
        // ldr q28, [x1, #16]                 // *......................................
        // ldr q11, [x1], #32                 // *......................................
        // ldr q13, [x5], #32                 // ..*....................................
        // ldr q27, [x4, #-16]                // ..*....................................
        // ldr q22, [x5, #-16]                // ...*...................................
        // uzp1 v1.8H, v11.8H, v28.8H         // ....*..................................
        // uzp2 v6.8H, v11.8H, v28.8H         // ....*..................................
        // uzp1 v16.8H, v7.8H, v27.8H         // .............*.........................
        // uzp2 v17.8H, v13.8H, v22.8H        // ..........*............................
        // ld1 {v20.8H}, [x3], #16            // ......*................................
        // smull2 v8.4S, v1.8H, v21.8H        // ...........*...........................
        // uzp1 v30.8H, v13.8H, v22.8H        // ...............*.......................
        // smlal2 v8.4S, v6.8H, v24.8H        // ............*..........................
        // smlal2 v8.4S, v16.8H, v17.8H       // ...............*.......................
        // uzp2 v12.8H, v7.8H, v27.8H         // ...........*...........................
        // smull v18.4S, v1.4H, v21.4H        // ........*..............................
        // smlal v18.4S, v6.4H, v24.4H        // .........*.............................
        // smlal2 v8.4S, v12.8H, v30.8H       // .................*.....................
        // smull2 v23.4S, v1.8H, v24.8H       // .......*...............................
        // smull v26.4S, v1.4H, v24.4H        // .............*.........................
        // smlal v18.4S, v16.4H, v17.4H       // ................*......................
        // ldr q7, [x4], #32                  // ...................*...................
        // ldr q10, [x2, #16]                 // ..............*........................
        // smlal v18.4S, v12.4H, v30.4H       // ..................*....................
        // smlal2 v23.4S, v6.8H, v20.8H       // ..........*............................
        // ldr q14, [x2], #32                 // .........*.............................
        // smlal2 v23.4S, v16.8H, v30.8H      // ...................*...................
        // smlal2 v23.4S, v12.8H, v15.8H      // ....................*..................
        // smlal v26.4S, v6.4H, v20.4H        // ..............*........................
        // uzp1 v5.8H, v18.8H, v8.8H          // .......................*...............
        // uzp2 v21.8H, v14.8H, v10.8H        // .........................*.............
        // smlal v26.4S, v16.4H, v30.4H       // .....................*.................
        // mul v29.8H, v5.8H, v2.8H           // .........................*.............
        // uzp1 v24.8H, v14.8H, v10.8H        // ..................*....................
        // smlal v26.4S, v12.4H, v15.4H       // ......................*................
        // ld1 {v15.8H}, [x6], #16            // .....................*.................
        // ldr q28, [x1, #16]                 // .......*...............................
        // ldr q11, [x1], #32                 // ........*..............................
        // ldr q13, [x5], #32                 // ................*......................
        // ldr q27, [x4, #-16]                // .................*.....................
        // smlal2 v8.4S, v29.8H, v0.8H        // ...............................*.......
        // ldr q22, [x5, #-16]                // ....................*..................
        // smlal v18.4S, v29.4H, v0.4H        // ..............................*........
        // uzp1 v4.8H, v26.8H, v23.8H         // ..........................*............
        // uzp1 v1.8H, v11.8H, v28.8H         // ............*..........................
        // uzp2 v6.8H, v11.8H, v28.8H         // .................................*.....
        // uzp1 v16.8H, v7.8H, v27.8H         // ..................................*....
        // mul v31.8H, v4.8H, v2.8H           // ............................*..........
        // uzp2 v17.8H, v13.8H, v22.8H        // ...................................*...
        // ld1 {v20.8H}, [x3], #16            // ......................*................
        // uzp2 v9.8H, v18.8H, v8.8H          // .....................................*.
        // smull2 v8.4S, v1.8H, v21.8H        // ...........................*...........
        // uzp1 v30.8H, v13.8H, v22.8H        // ................................*......
        // smlal2 v8.4S, v6.8H, v24.8H        // ...................................*...
        // smlal2 v8.4S, v16.8H, v17.8H       // .....................................*.
        // uzp2 v12.8H, v7.8H, v27.8H         // ....................................*..
        // smlal v26.4S, v31.4H, v0.4H        // .................................*.....
        // smlal2 v23.4S, v31.8H, v0.8H       // ..................................*....
        // smull v18.4S, v1.4H, v21.4H        // ................................*......
        // smlal v18.4S, v6.4H, v24.4H        // ....................................*..
        // smlal2 v8.4S, v12.8H, v30.8H       // ......................................*
        // uzp2 v19.8H, v26.8H, v23.8H        // ......................................*
        // smull2 v23.4S, v1.8H, v24.8H       // .......................*...............
        // smull v26.4S, v1.4H, v24.4H        // ........................*..............

        sub count, count, #2
polyvec_basemul_acc_montgomery_cached_k2_loop_start:
                                             // Instructions:    48
                                             // Expected cycles: 27
                                             // Expected IPC:    1.78
                                             //
                                             // Cycle bound:     25.0
                                             // IPC bound:       1.92
                                             //
                                             // Wall time:     60.02s
                                             // User time:     60.02s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        smlal v18.4S, v16.4H, v17.4H         // *.............................
        ldr q7, [x4], #32                    // e.............................
        ldr q10, [x2, #16]                   // .e............................
        smlal v18.4S, v12.4H, v30.4H         // .*............................
        smlal2 v23.4S, v6.8H, v20.8H         // ..*...........................
        ldr q14, [x2], #32                   // ..e...........................
        smlal2 v23.4S, v16.8H, v30.8H        // ...*..........................
        zip1 v25.8H, v19.8H, v9.8H           // ...l..........................
        zip2 v3.8H, v19.8H, v9.8H            // ....l.........................
        smlal2 v23.4S, v12.8H, v15.8H        // ....*.........................
        smlal v26.4S, v6.4H, v20.4H          // .....*........................
        uzp1 v5.8H, v18.8H, v8.8H            // .....*........................
        uzp2 v21.8H, v14.8H, v10.8H          // ......e.......................
        smlal v26.4S, v16.4H, v30.4H         // ......*.......................
        str q25, [x0], #32                   // .......l......................
        mul v29.8H, v5.8H, v2.8H             // .......*......................
        uzp1 v24.8H, v14.8H, v10.8H          // ........e.....................
        str q3, [x0, #-16]                   // ........l.....................
        smlal v26.4S, v12.4H, v15.4H         // .........*....................
        ld1 {v15.8H}, [x6], #16              // .........e....................
        ldr q28, [x1, #16]                   // ..........e...................
        ldr q11, [x1], #32                   // ..........e...................
        ldr q13, [x5], #32                   // ...........e..................
        ldr q27, [x4, #-16]                  // ...........e..................
        smlal2 v8.4S, v29.8H, v0.8H          // ............*.................
        ldr q22, [x5, #-16]                  // ............e.................
        smlal v18.4S, v29.4H, v0.4H          // .............*................
        uzp1 v4.8H, v26.8H, v23.8H           // .............*................
        uzp1 v1.8H, v11.8H, v28.8H           // ..............e...............
        uzp2 v6.8H, v11.8H, v28.8H           // ..............e...............
        uzp1 v16.8H, v7.8H, v27.8H           // ...............e..............
        mul v31.8H, v4.8H, v2.8H             // ...............*..............
        uzp2 v17.8H, v13.8H, v22.8H          // ................e.............
        ld1 {v20.8H}, [x3], #16              // ................e.............
        uzp2 v9.8H, v18.8H, v8.8H            // .................*............
        smull2 v8.4S, v1.8H, v21.8H          // .................e............
        uzp1 v30.8H, v13.8H, v22.8H          // ..................e...........
        smlal2 v8.4S, v6.8H, v24.8H          // ..................e...........
        smlal2 v8.4S, v16.8H, v17.8H         // ...................e..........
        uzp2 v12.8H, v7.8H, v27.8H           // ...................e..........
        smlal v26.4S, v31.4H, v0.4H          // ....................*.........
        smlal2 v23.4S, v31.8H, v0.8H         // .....................*........
        smull v18.4S, v1.4H, v21.4H          // ......................e.......
        smlal v18.4S, v6.4H, v24.4H          // .......................e......
        smlal2 v8.4S, v12.8H, v30.8H         // ........................e.....
        uzp2 v19.8H, v26.8H, v23.8H          // .........................*....
        smull2 v23.4S, v1.8H, v24.8H         // .........................e....
        smull v26.4S, v1.4H, v24.4H          // ..........................e...

                                             // ---------------------- cycle (expected) ---------------------->
                                             // 0                        25                       50
                                             // |------------------------|------------------------|------------
        // ldr q12, [x1], #32                // ..........e................'.........~................'........
        // ldr q13, [x1, #-16]               // ..........e................'.........~................'........
        // uzp1 v3.8h, v12.8h, v13.8h        // ..............e............'.............~............'........
        // uzp2 v4.8h, v12.8h, v13.8h        // ..............e............'.............~............'........
        // ldr q12, [x2], #32                // ..e........................'.~........................'.~......
        // ldr q13, [x2, #-16]               // .e.........................'~.........................'~.......
        // uzp1 v5.8h, v12.8h, v13.8h        // ........e..................'.......~..................'........
        // uzp2 v6.8h, v12.8h, v13.8h        // ......e....................'.....~....................'.....~..
        // ld1 {v7.8h}, [x3], #16            // ................e..........'...............~..........'........
        // smull  v8.4s, v3.4h, v5.4h        // ..........................e'.........................~'........
        // smull2 v10.4s, v3.8h, v5.8h       // .........................e.'........................~.'........
        // smlal  v8.4s, v4.4h, v7.4h        // .....~.....................'....*.....................'....~...
        // smlal2 v10.4s, v4.8h, v7.8h       // ..~........................'.*........................'.~......
        // smull  v9.4s, v3.4h, v6.4h        // ......................e....'.....................~....'........
        // smull2 v11.4s, v3.8h, v6.8h       // .................e.........'................~.........'........
        // smlal  v9.4s, v4.4h, v5.4h        // .......................e...'......................~...'........
        // smlal2 v11.4s, v4.8h, v5.8h       // ..................e........'.................~........'........
        // ldr q12, [x4], #32                // e..........................~..........................~........
        // ldr q13, [x4, #-16]               // ...........e...............'..........~...............'........
        // uzp1 v3.8h, v12.8h, v13.8h        // ...............e...........'..............~...........'........
        // uzp2 v4.8h, v12.8h, v13.8h        // ...................e.......'..................~.......'........
        // ldr q12, [x5], #32                // ...........e...............'..........~...............'........
        // ldr q13, [x5, #-16]               // ............e..............'...........~..............'........
        // uzp1 v5.8h, v12.8h, v13.8h        // ..................e........'.................~........'........
        // uzp2 v6.8h, v12.8h, v13.8h        // ................e..........'...............~..........'........
        // ld1 {v7.8h}, [x6], #16            // .........e.................'........~.................'........
        // smlal  v8.4s, v3.4h, v5.4h        // ......~....................'.....*....................'.....~..
        // smlal2 v10.4s, v3.8h, v5.8h       // ...~.......................'..*.......................'..~.....
        // smlal  v8.4s, v4.4h, v7.4h        // .........~.................'........*.................'........
        // smlal2 v10.4s, v4.8h, v7.8h       // ....~......................'...*......................'...~....
        // smlal  v9.4s, v3.4h, v6.4h        // ~..........................*..........................~........
        // smlal2 v11.4s, v3.8h, v6.8h       // ...................e.......'..................~.......'........
        // smlal  v9.4s, v4.4h, v5.4h        // .~.........................'*.........................'~.......
        // smlal2 v11.4s, v4.8h, v5.8h       // ........................e..'.......................~..'........
        // uzp1   v28.8h, v8.8h, v10.8h      // .............~.............'............*.............'........
        // mul    v28.8h, v28.8h, v2.8h      // ...............~...........'..............*...........'........
        // smlal  v8.4s, v28.4h, v0.4h       // ....................~......'...................*......'........
        // smlal2 v10.4s, v28.8h, v0.8h      // .....................~.....'....................*.....'........
        // uzp2   v26.8h, v8.8h, v10.8h      // .........................~.'........................*.'........
        // uzp1   v28.8h, v9.8h, v11.8h      // .....~.....................'....*.....................'....~...
        // mul    v28.8h, v28.8h, v2.8h      // .......~...................'......*...................'......~.
        // smlal  v9.4s, v28.4h, v0.4h       // .............~.............'............*.............'........
        // smlal2 v11.4s, v28.8h, v0.8h      // ............~..............'...........*..............'........
        // uzp2   v27.8h, v9.8h, v11.8h      // .................~.........'................*.........'........
        // zip1 v12.8h, v26.8h, v27.8h       // ...~.......................'..~.......................'..l.....
        // zip2 v13.8h, v26.8h, v27.8h       // ....~......................'...~......................'...l....
        // str q12, [x0], #32                // .......~...................'......~...................'......l.
        // str q13, [x0, #-16]               // ........~..................'.......~..................'.......l

        subs count, count, 1
        cbnz count, polyvec_basemul_acc_montgomery_cached_k2_loop_start
                                             // Instructions:    26
                                             // Expected cycles: 28
                                             // Expected IPC:    0.93
                                             //
                                             // Cycle bound:     28.0
                                             // IPC bound:       0.93
                                             //
                                             // Wall time:     0.14s
                                             // User time:     0.14s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        smlal v26.4S, v6.4H, v20.4H          // *.............................
        smlal2 v23.4S, v6.8H, v20.8H         // .*............................
        smlal v26.4S, v16.4H, v30.4H         // ..*...........................
        smlal2 v23.4S, v16.8H, v30.8H        // ...*..........................
        smlal v26.4S, v12.4H, v15.4H         // ....*.........................
        smlal2 v23.4S, v12.8H, v15.8H        // .....*........................
        smlal v18.4S, v16.4H, v17.4H         // ......*.......................
        smlal v18.4S, v12.4H, v30.4H         // .......*......................
        zip1 v12.8H, v19.8H, v9.8H           // .......*......................
        str q12, [x0], #32                   // .........*....................
        uzp1 v12.8H, v26.8H, v23.8H          // .........*....................
        mul v6.8H, v12.8H, v2.8H             // ...........*..................
        uzp1 v12.8H, v18.8H, v8.8H           // ...........*..................
        mul v12.8H, v12.8H, v2.8H            // .............*................
        smlal v26.4S, v6.4H, v0.4H           // ................*.............
        smlal2 v23.4S, v6.8H, v0.8H          // .................*............
        smlal2 v8.4S, v12.8H, v0.8H          // ..................*...........
        smlal v18.4S, v12.4H, v0.4H          // ...................*..........
        zip2 v12.8H, v19.8H, v9.8H           // ...................*..........
        uzp2 v6.8H, v26.8H, v23.8H           // .....................*........
        str q12, [x0, #-16]                  // .....................*........
        uzp2 v12.8H, v18.8H, v8.8H           // .......................*......
        zip2 v1.8H, v6.8H, v12.8H            // .........................*....
        zip1 v12.8H, v6.8H, v12.8H           // .........................*....
        str q1, [x0, #16]                    // ...........................*..
        str q12, [x0], #32                   // ...........................*..

                                              // ------ cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|-----
        // smlal v18.4S, v16.4H, v17.4H       // ......*........................
        // smlal v18.4S, v12.4H, v30.4H       // .......*.......................
        // smlal2 v23.4S, v6.8H, v20.8H       // .*.............................
        // smlal2 v23.4S, v16.8H, v30.8H      // ...*...........................
        // zip1 v25.8H, v19.8H, v9.8H         // .......*.......................
        // zip2 v3.8H, v19.8H, v9.8H          // ...................*...........
        // smlal2 v23.4S, v12.8H, v15.8H      // .....*.........................
        // smlal v26.4S, v6.4H, v20.4H        // *..............................
        // uzp1 v5.8H, v18.8H, v8.8H          // ...........*...................
        // smlal v26.4S, v16.4H, v30.4H       // ..*............................
        // str q25, [x0], #32                 // .........*.....................
        // mul v29.8H, v5.8H, v2.8H           // .............*.................
        // str q3, [x0, #-16]                 // .....................*.........
        // smlal v26.4S, v12.4H, v15.4H       // ....*..........................
        // smlal2 v8.4S, v29.8H, v0.8H        // ..................*............
        // smlal v18.4S, v29.4H, v0.4H        // ...................*...........
        // uzp1 v4.8H, v26.8H, v23.8H         // .........*.....................
        // mul v31.8H, v4.8H, v2.8H           // ...........*...................
        // uzp2 v9.8H, v18.8H, v8.8H          // .......................*.......
        // smlal v26.4S, v31.4H, v0.4H        // ................*..............
        // smlal2 v23.4S, v31.8H, v0.8H       // .................*.............
        // uzp2 v19.8H, v26.8H, v23.8H        // .....................*.........
        // zip1 v25.8H, v19.8H, v9.8H         // .........................*.....
        // zip2 v3.8H, v19.8H, v9.8H          // .........................*.....
        // str q25, [x0], #32                 // ...........................*...
        // str q3, [x0, #-16]                 // ...........................*...


        pop_stack
        ret

/****************** REGISTER DEALLOCATIONS *******************/
    .unreq out
    .unreq a0_ptr
    .unreq b0_ptr
    .unreq b0_cache_ptr
    .unreq a1_ptr
    .unreq b1_ptr
    .unreq b1_cache_ptr
    .unreq a2_ptr
    .unreq b2_ptr
    .unreq b2_cache_ptr
    .unreq a3_ptr
    .unreq b3_ptr
    .unreq b3_cache_ptr
    .unreq count
    .unreq modulus
    .unreq modulus_twisted
    .unreq aa0
    .unreq aa1
    .unreq bb0
    .unreq bb1
    .unreq bb1t
    .unreq res0l
    .unreq res1l
    .unreq res0h
    .unreq wtmp
    .unreq res1h
    .unreq tmp0
    .unreq tmp1
    .unreq q_tmp0
    .unreq q_tmp1
    .unreq out0
    .unreq out1
    .unreq t0

/* simpasm: footer-start */

#endif /* MLK_ARITH_BACKEND_AARCH64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED && \
          (MLK_CONFIG_MULTILEVEL_WITH_SHARED || MLKEM_K == 2) */
