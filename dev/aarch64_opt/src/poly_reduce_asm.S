/*
 * Copyright (c) The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

/*yaml
  Name: poly_reduce_asm
  Description: Barrett reduction of polynomial coefficients
  Signature: void mlk_poly_reduce_asm(int16_t p[256])
  ABI:
    x0:
      type: buffer
      size_bytes: 512
      permissions: read/write
      c_parameter: int16_t p[256]
      description: Input/output polynomial
  Stack:
    bytes: 0
*/

#include "../../../common.h"
#if defined(MLK_ARITH_BACKEND_AARCH64) &&  !defined(MLK_CONFIG_MULTILEVEL_NO_SHARED)
/* simpasm: header-end */

/* Barrett reduction */
.macro barrett_reduce a
        sqdmulh tmp.8h,   \a\().8h, modulus_twisted.h[0]
        srshr   tmp.8h,   tmp.8h,   #11
        mls     \a\().8h, tmp.8h,   modulus.h[0]
.endm

/* Turns signed-canonical to unsigned canonical representative
 * through conditional addition of the modulus.
 *
 * Expected modulus in `modulus`. */
.macro scalar_signed_to_unsigned a
        sshr mask.8h, \a\().8h, #15
        and mask.16b, modulus.16b, mask.16b
        add \a\().8h, \a\().8h, mask.8h
.endm

        ptr               .req x0
        count             .req x1
        wtmp              .req w2

        data              .req v0
        q_data            .req q0

        tmp               .req v1
        mask              .req v2
        modulus           .req v3
        modulus_twisted   .req v4

        .text
        .global MLK_ASM_NAMESPACE(poly_reduce_asm)
        .balign 4
MLK_ASM_FN_SYMBOL(poly_reduce_asm)

        mov wtmp, #3329 // ML-KEM modulus
        dup modulus.8h, wtmp

        mov wtmp, #20159 // Barrett twist of 1 wrt 2^27
        dup modulus_twisted.8h, wtmp

        mov count, #8
                                               // Instructions:    25
                                               // Expected cycles: 25
                                               // Expected IPC:    1.00
                                               //
                                               // Cycle bound:     25.0
                                               // IPC bound:       1.00
                                               //
                                               // Wall time:     0.12s
                                               // User time:     0.12s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        ldr q21, [x0], #64                     // *.............................
        ldr q18, [x0, #-32]                    // *.............................
        ldr q0, [x0, #-48]                     // .*............................
        ldr q5, [x0, #-16]                     // .*............................
        ldr q26, [x0], #64                     // ..*...........................
        sqdmulh v17.8H, v21.8H, v4.H[0]        // ....*.........................
        sqdmulh v27.8H, v18.8H, v4.H[0]        // ......*.......................
        sqdmulh v22.8H, v0.8H, v4.H[0]         // ........*.....................
        srshr v17.8H, v17.8H, #11              // .........*....................
        sqdmulh v23.8H, v5.8H, v4.H[0]         // ..........*...................
        srshr v29.8H, v27.8H, #11              // ...........*..................
        mls v21.8H, v17.8H, v3.H[0]            // .............*................
        srshr v17.8H, v22.8H, #11              // .............*................
        mls v18.8H, v29.8H, v3.H[0]            // ...............*..............
        srshr v22.8H, v23.8H, #11              // ...............*..............
        mls v0.8H, v17.8H, v3.H[0]             // .................*............
        sshr v2.8H, v21.8H, #15                // ..................*...........
        mls v5.8H, v22.8H, v3.H[0]             // ...................*..........
        sshr v29.8H, v18.8H, #15               // ....................*.........
        and v19.16B, v3.16B, v2.16B            // .....................*........
        sqdmulh v2.8H, v26.8H, v4.H[0]         // .....................*........
        sshr v31.8H, v0.8H, #15                // ......................*.......
        add v17.8H, v21.8H, v19.8H             // .......................*......
        and v21.16B, v3.16B, v29.16B           // .......................*......
        and v31.16B, v3.16B, v31.16B           // ........................*.....

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ldr q26, [x0], #64                   // *..............................
        // sqdmulh v2.8H, v26.8H, v4.H[0]       // ....*..........................
        // ldr q18, [x0, #-32]                  // *..............................
        // ldr q0, [x0, #-48]                   // .*.............................
        // srshr v23.8H, v2.8H, #11             // .........*.....................
        // sqdmulh v30.8H, v18.8H, v4.H[0]      // ......*........................
        // sqdmulh v7.8H, v0.8H, v4.H[0]        // ........*......................
        // ldr q5, [x0, #-16]                   // .*.............................
        // mls v26.8H, v23.8H, v3.H[0]          // .............*.................
        // srshr v6.8H, v30.8H, #11             // ...........*...................
        // srshr v1.8H, v7.8H, #11              // .............*.................
        // sqdmulh v19.8H, v5.8H, v4.H[0]       // ..........*....................
        // mls v18.8H, v6.8H, v3.H[0]           // ...............*...............
        // sshr v24.8H, v26.8H, #15             // ..................*............
        // mls v0.8H, v1.8H, v3.H[0]            // .................*.............
        // and v27.16B, v3.16B, v24.16B         // .....................*.........
        // srshr v29.8H, v19.8H, #11            // ...............*...............
        // add v17.8H, v26.8H, v27.8H           // .......................*.......
        // ldr q26, [x0], #64                   // ..*............................
        // sshr v1.8H, v18.8H, #15              // ....................*..........
        // mls v5.8H, v29.8H, v3.H[0]           // ...................*...........
        // sshr v20.8H, v0.8H, #15              // ......................*........
        // and v21.16B, v3.16B, v1.16B          // .......................*.......
        // and v31.16B, v3.16B, v20.16B         // ........................*......
        // sqdmulh v2.8H, v26.8H, v4.H[0]       // .....................*.........

        sub count, count, #2
poly_reduce_loop_start:
                                               // Instructions:    32
                                               // Expected cycles: 23
                                               // Expected IPC:    1.39
                                               //
                                               // Cycle bound:     23.0
                                               // IPC bound:       1.39
                                               //
                                               // Wall time:     8.79s
                                               // User time:     8.79s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        add v21.8H, v18.8H, v21.8H             // l.............................
        ldr q18, [x0, #-32]                    // *.............................
        add v25.8H, v0.8H, v31.8H              // .l............................
        ldr q0, [x0, #-48]                     // .*............................
        str q21, [x0, #-96]                    // ..l...........................
        sshr v28.8H, v5.8H, #15                // ..l...........................
        str q17, [x0, #-128]                   // ...l..........................
        srshr v23.8H, v2.8H, #11               // ....*.........................
        sqdmulh v30.8H, v18.8H, v4.H[0]        // ....*.........................
        str q25, [x0, #-112]                   // .....l........................
        and v22.16B, v3.16B, v28.16B           // .....l........................
        sqdmulh v7.8H, v0.8H, v4.H[0]          // ......*.......................
        add v16.8H, v5.8H, v22.8H              // .......l......................
        ldr q5, [x0, #-16]                     // .......*......................
        mls v26.8H, v23.8H, v3.H[0]            // ........*.....................
        str q16, [x0, #-80]                    // .........l....................
        srshr v6.8H, v30.8H, #11               // .........*....................
        srshr v1.8H, v7.8H, #11                // ...........*..................
        sqdmulh v19.8H, v5.8H, v4.H[0]         // ...........*..................
        mls v18.8H, v6.8H, v3.H[0]             // .............*................
        sshr v24.8H, v26.8H, #15               // .............*................
        mls v0.8H, v1.8H, v3.H[0]              // ...............*..............
        and v27.16B, v3.16B, v24.16B           // ...............*..............
        srshr v29.8H, v19.8H, #11              // ................*.............
        add v17.8H, v26.8H, v27.8H             // .................*............
        ldr q26, [x0], #64                     // .................e............
        sshr v1.8H, v18.8H, #15                // ..................*...........
        mls v5.8H, v29.8H, v3.H[0]             // ....................*.........
        sshr v20.8H, v0.8H, #15                // ....................*.........
        and v21.16B, v3.16B, v1.16B            // .....................*........
        and v31.16B, v3.16B, v20.16B           // ......................*.......
        sqdmulh v2.8H, v26.8H, v4.H[0]         // ......................e.......

                                                // ---------- cycle (expected) ---------->
                                                // 0                        25
                                                // |------------------------|-------------
        // ldr q0, [x0], #64                    // e.....'................~.....'.........
        // sqdmulh v1.8h,   v0.8h, v4.h[0]      // .....e'.....................~'.........
        // srshr   v1.8h,   v1.8h,   #11        // ......'...*..................'...~.....
        // mls     v0.8h, v1.8h,   v3.h[0]      // ......'.......*..............'.......~.
        // sshr v2.8h, v0.8h, #15               // ......'............*.........'.........
        // and v2.16b, v3.16b, v2.16b           // ......'..............*.......'.........
        // add v0.8h, v0.8h, v2.8h              // ~.....'................*.....'.........
        // str q0, [x0, #-64]                   // ......'..~...................'..l......
        // ldr q0, [x0, #-48]                   // ......'*.....................'~........
        // sqdmulh v1.8h,   v0.8h, v4.h[0]      // ......'.....*................'.....~...
        // srshr   v1.8h,   v1.8h,   #11        // ......'..........*...........'.........
        // mls     v0.8h, v1.8h,   v3.h[0]      // ......'..............*.......'.........
        // sshr v2.8h, v0.8h, #15               // ...~..'...................*..'.........
        // and v2.16b, v3.16b, v2.16b           // .....~'.....................*'.........
        // add v0.8h, v0.8h, v2.8h              // ......'~.....................'l........
        // str q0, [x0, #-48]                   // ......'....~.................'....l....
        // ldr q0, [x0, #-32]                   // ......*......................~.........
        // sqdmulh v1.8h,   v0.8h, v4.h[0]      // ......'...*..................'...~.....
        // srshr   v1.8h,   v1.8h,   #11        // ......'........*.............'.........
        // mls     v0.8h, v1.8h,   v3.h[0]      // ......'............*.........'.........
        // sshr v2.8h, v0.8h, #15               // .~....'.................*....'.........
        // and v2.16b, v3.16b, v2.16b           // ....~.'....................*.'.........
        // add v0.8h, v0.8h, v2.8h              // ......~......................l.........
        // str q0, [x0, #-32]                   // ......'.~....................'.l.......
        // ldr q0, [x0, #-16]                   // ......'......*...............'......~..
        // sqdmulh v1.8h,   v0.8h, v4.h[0]      // ......'..........*...........'.........
        // srshr   v1.8h,   v1.8h,   #11        // ......'...............*......'.........
        // mls     v0.8h, v1.8h,   v3.h[0]      // ...~..'...................*..'.........
        // sshr v2.8h, v0.8h, #15               // ......'.~....................'.l.......
        // and v2.16b, v3.16b, v2.16b           // ......'....~.................'....l....
        // add v0.8h, v0.8h, v2.8h              // ......'......~...............'......l..
        // str q0, [x0, #-16]                   // ......'........~.............'........l

        subs count, count, 1
        cbnz count, poly_reduce_loop_start
                                               // Instructions:    39
                                               // Expected cycles: 29
                                               // Expected IPC:    1.34
                                               //
                                               // Cycle bound:     29.0
                                               // IPC bound:       1.34
                                               //
                                               // Wall time:     0.24s
                                               // User time:     0.24s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        add v28.8H, v0.8H, v31.8H              // *.............................
        ldr q29, [x0, #-16]                    // *.............................
        add v21.8H, v18.8H, v21.8H             // .*............................
        srshr v18.8H, v2.8H, #11               // .*............................
        sshr v2.8H, v5.8H, #15                 // ..*...........................
        ldr q16, [x0, #-32]                    // ..*...........................
        str q17, [x0, #-128]                   // ...*..........................
        ldr q0, [x0, #-48]                     // ...*..........................
        and v2.16B, v3.16B, v2.16B             // ....*.........................
        sqdmulh v24.8H, v29.8H, v4.H[0]        // ....*.........................
        str q28, [x0, #-112]                   // .....*........................
        str q21, [x0, #-96]                    // .....*........................
        add v31.8H, v5.8H, v2.8H               // ......*.......................
        sqdmulh v6.8H, v16.8H, v4.H[0]         // ......*.......................
        str q31, [x0, #-80]                    // ........*.....................
        sqdmulh v17.8H, v0.8H, v4.H[0]         // ........*.....................
        srshr v22.8H, v24.8H, #11              // .........*....................
        mls v26.8H, v18.8H, v3.H[0]            // ..........*...................
        srshr v31.8H, v6.8H, #11               // ...........*..................
        mls v29.8H, v22.8H, v3.H[0]            // .............*................
        srshr v19.8H, v17.8H, #11              // .............*................
        mls v16.8H, v31.8H, v3.H[0]            // ...............*..............
        sshr v7.8H, v26.8H, #15                // ...............*..............
        mls v0.8H, v19.8H, v3.H[0]             // .................*............
        and v5.16B, v3.16B, v7.16B             // .................*............
        sshr v22.8H, v29.8H, #15               // ..................*...........
        add v27.8H, v26.8H, v5.8H              // ...................*..........
        and v26.16B, v3.16B, v22.16B           // ....................*.........
        sshr v20.8H, v16.8H, #15               // ....................*.........
        str q27, [x0, #-64]                    // .....................*........
        and v2.16B, v3.16B, v20.16B            // ......................*.......
        sshr v23.8H, v0.8H, #15                // ......................*.......
        add v18.8H, v29.8H, v26.8H             // .......................*......
        add v31.8H, v16.8H, v2.8H              // ........................*.....
        and v29.16B, v3.16B, v23.16B           // ........................*.....
        str q18, [x0, #-16]                    // .........................*....
        add v25.8H, v0.8H, v29.8H              // ..........................*...
        str q31, [x0, #-32]                    // ..........................*...
        str q25, [x0, #-48]                    // ............................*.

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // add v21.8H, v18.8H, v21.8H           // .*.............................
        // ldr q18, [x0, #-32]                  // ..*............................
        // add v25.8H, v0.8H, v31.8H            // *..............................
        // ldr q0, [x0, #-48]                   // ...*...........................
        // str q21, [x0, #-96]                  // .....*.........................
        // sshr v28.8H, v5.8H, #15              // ..*............................
        // str q17, [x0, #-128]                 // ...*...........................
        // srshr v23.8H, v2.8H, #11             // .*.............................
        // sqdmulh v30.8H, v18.8H, v4.H[0]      // ......*........................
        // str q25, [x0, #-112]                 // .....*.........................
        // and v22.16B, v3.16B, v28.16B         // ....*..........................
        // sqdmulh v7.8H, v0.8H, v4.H[0]        // ........*......................
        // add v16.8H, v5.8H, v22.8H            // ......*........................
        // ldr q5, [x0, #-16]                   // *..............................
        // mls v26.8H, v23.8H, v3.H[0]          // ..........*....................
        // str q16, [x0, #-80]                  // ........*......................
        // srshr v6.8H, v30.8H, #11             // ...........*...................
        // srshr v1.8H, v7.8H, #11              // .............*.................
        // sqdmulh v19.8H, v5.8H, v4.H[0]       // ....*..........................
        // mls v18.8H, v6.8H, v3.H[0]           // ...............*...............
        // sshr v24.8H, v26.8H, #15             // ...............*...............
        // mls v0.8H, v1.8H, v3.H[0]            // .................*.............
        // and v27.16B, v3.16B, v24.16B         // .................*.............
        // srshr v29.8H, v19.8H, #11            // .........*.....................
        // add v17.8H, v26.8H, v27.8H           // ...................*...........
        // sshr v1.8H, v18.8H, #15              // ....................*..........
        // mls v5.8H, v29.8H, v3.H[0]           // .............*.................
        // sshr v20.8H, v0.8H, #15              // ......................*........
        // and v21.16B, v3.16B, v1.16B          // ......................*........
        // and v31.16B, v3.16B, v20.16B         // ........................*......
        // add v21.8H, v18.8H, v21.8H           // ........................*......
        // add v25.8H, v0.8H, v31.8H            // ..........................*....
        // str q21, [x0, #-32]                  // ..........................*....
        // sshr v28.8H, v5.8H, #15              // ..................*............
        // str q17, [x0, #-64]                  // .....................*.........
        // str q25, [x0, #-48]                  // ............................*..
        // and v22.16B, v3.16B, v28.16B         // ....................*..........
        // add v16.8H, v5.8H, v22.8H            // .......................*.......
        // str q16, [x0, #-16]                  // .........................*.....


        ret

        .unreq ptr
        .unreq count
        .unreq wtmp

        .unreq data
        .unreq q_data

        .unreq tmp
        .unreq mask
        .unreq modulus
        .unreq modulus_twisted

/* simpasm: footer-start */
#endif /* MLK_ARITH_BACKEND_AARCH64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED */
